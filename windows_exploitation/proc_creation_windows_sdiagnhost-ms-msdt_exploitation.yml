title: ms-msdt for RCE - sdiagnhost.exe spawning command
id: 6469c7a1-8a28-40c4-a72b-5acddcfd0b0b
description: Detecting sdiagnhost.exe executing the POC as a result of vulnerability based on ms-msdt.
status: experimental
references:
  - https://twitter.com/nao_sec/status/1530196847679401984
  - https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e
author: '@Kostastsale'
date: 2022/05/29
logsource:
    category: process_creation
    product: windows
detection:
    selection1:
        ParentImage|endswith:
          - '\sdiagnhost.exe'
        Image|endswith:
          - '\cmd.exe'
          - '\powershell.exe'
    filter1:
        Image|endswith:
          - '\cmd.exe'
        CommandLine|contains:
          - 'bits'
    filter2:
        Image|endswith:
          - '\powershell.exe'
        CommandLine|endswith:
          - '-noprofile'
          - '-noprofile -'
    condition: selection1 and not (filter1 or filter2)
falsepositives:
    - Uknown
level: high
tags:
    - attack.execution
    - attack.T1059.003
    - attack.T1204.002